<div class="flex flex-col items-center w-full min-h-full p-4 sm:p-8">
  <div class="flex flex-col w-full max-w-5xl bg-primary_background_white/80 shadow-lg rounded-xl border-2 border-primary_orange_1 p-4 sm:p-10 overflow-hidden">
    <h2 class="text-3xl font-bold text-primary_orange mb-6 text-center">
      <!-- Overview over active questionnaires. -->
       {{ 'TMP_OVERVIEW_ACTIVE_QUESTIONNAIRES' | translate }}
    </h2>

    <!-- Search & Filters Row -->
    <div class="grid grid-cols-1 sm:grid-cols-[auto_1fr_auto] gap-6 items-center w-full">
      <!-- Search & Filters -->
      <div class="flex flex-col sm:flex-row w-full gap-3">
        <!-- <select
          #searchSelect
          (change)="onSearchTypeChange(searchSelect.value)"
          class="w-full sm:w-auto min-w-0 border border-primary_orange_1 rounded-xl px-3 py-2 focus:ring-primary_orange_1 focus:border-primary_orange_1 text-sm bg-gray-50"
        >
          <option value="name" selected>{{'TMP_SEARCH_BY_STUDENT_NAME'| translate}}</option> 
          <option value="id">{{'TMP_SEARCH_BY_QUESTIONNAIRE_ID'| translate}}</option>
        </select> -->

        <input
          #searchInput
          type="text"
          (input)="onSearchChange(searchInput.value)"
          placeholder="Search..."
          class="px-4 py-2 border border-primary_orange rounded-lg shadow-sm focus:ring-primary_orange focus:border-primary_orange text-sm w-full sm:flex-grow min-w-0 bg-primary_background_white/80"
        />
      </div>

      <!-- Completion Filters -->
      <div class="flex flex-col sm:flex-row items-start sm:items-center gap-3">
        <label class="flex items-center gap-2 text-primary_dark_blue">
          <input
            type="checkbox"
            [(ngModel)]="filterStudentCompleted"
            (change)="onCompletionFilterChange()"
          />
          <span class="text-sm">{{'FILTER_STUDENT_PENDING'| translate}}</span>
        </label>
        <label class="flex items-center gap-2 text-primary_dark_blue">
          <input
            type="checkbox"
            [(ngModel)]="filterTeacherCompleted"
            (change)="onCompletionFilterChange()"
          />
          <span class="text-sm">{{'FILTER_TEACHER_PENDING'| translate}}</span>
        </label>
      </div>

      <!-- Page Size Selector -->
      <div class="flex w-full sm:w-auto flex-col sm:flex-row gap-2 items-center">
        <label for="pageSize" class="text-primary_dark_light font-medium"> {{'TMP_ITEMS_PER_PAGE'| translate}}</label>
        <select
          #pageSize
          id="pageSize"
          (change)="onPageSizeChange(pageSize.value)"
          class="w-full sm:w-auto min-w-0 border border-primary_orange_1 rounded-xl px-3 py-2 focus:ring-primary_orange_1 focus:border-primary_orange_1 text-sm bg-gray-50"
        >
          <option *ngFor="let size of pageSizeOptions" [value]="size" [selected]="isSelectedPageSize(size)">
            {{ size }}
          </option>
        </select>
      </div>
    </div>

    <div class="flex justify-center items-center min-h-[150px]" *ngIf="isLoading">
      <app-loading></app-loading>
    </div>

    <!-- Error Message -->
    <div *ngIf="errorMessage" class="text-center p-4">
      <p class="text-accent_red font-semibold text-lg">{{ errorMessage }}</p>
    </div>

    <!-- Grouped list (matches admin ActiveList styling) -->
    <div *ngIf="!isLoading && !errorMessage" class="mt-8 w-full">
      <div *ngFor="let group of displayedGroups" class="mb-6 p-2 bg-gray-50 rounded-xl border border-primary_orange_1 shadow-sm hover:bg-secondary_background_hover transition-colors">
        <button
          type="button"
          class="w-full text-left p-2"
          (click)="toggleGroupCollapse(group.groupId)"
          [attr.aria-expanded]="!groupCollapsed[group.groupId]"
          [attr.aria-controls]="'group-panel-' + group.groupId">

          <!-- Group header: name, status (left) and arrow (right) -->
          <div class="flex items-center justify-between gap-2">
            <div class="flex flex-col sm:flex-row sm:items-center gap-2">
              <h3 class="text-lg sm:text-xl font-bold text-primary_dark_blue leading-snug mb-1 sm:mb-0">
                {{ group.groupName }}
              </h3>
              <div class="flex flex-row flex-wrap gap-2 text-xs sm:text-sm text-gray-600">
                <span>
                  {{ 'ACTIVE_LIST.GROUP_STUDENT' | translate }}
                  <span
                    [ngClass]="{
                      'text-red-600 font-bold': getAnsweredCount(group.questionnaires, 'student') === 0,
                      'text-yellow-600 font-bold': getAnsweredCount(group.questionnaires, 'student') > 0 && getAnsweredCount(group.questionnaires, 'student') < group.questionnaires.length,
                      'text-green-600 font-bold': getAnsweredCount(group.questionnaires, 'student') === group.questionnaires.length
                    }">
                    {{ getAnsweredCount(group.questionnaires, 'student') }}
                  </span>
                  /
                  <span class="text-gray-800">{{ group.questionnaires.length }}</span>
                </span>
                <span>
                  {{ 'ACTIVE_LIST.GROUP_TEACHER' | translate }}
                  <span
                    [ngClass]="{
                      'text-red-600 font-bold': getAnsweredCount(group.questionnaires, 'teacher') === 0,
                      'text-yellow-600 font-bold': getAnsweredCount(group.questionnaires, 'teacher') > 0 && getAnsweredCount(group.questionnaires, 'teacher') < group.questionnaires.length,
                      'text-green-600 font-bold': getAnsweredCount(group.questionnaires, 'teacher') === group.questionnaires.length
                    }">
                    {{ getAnsweredCount(group.questionnaires, 'teacher') }}
                  </span>
                  /
                  <span class="text-gray-800">{{ group.questionnaires.length }}</span>
                </span>
              </div>
            </div>
            <!-- Collapse arrow on the right -->
            <span [class.rotate-180]="!groupCollapsed[group.groupId]" class="transition-transform duration-300 text-lg ml-4">â–¼</span>
          </div>

          <!-- Questionnaires list -->
          <div *ngIf="!groupCollapsed[group.groupId]" class="mt-3 sm:mt-4" id="{{ 'group-panel-' + group.groupId }}">
            <ul class="space-y-3 sm:space-y-4">
              <li
                *ngFor="let q of group.questionnaires"
                class="p-2 px-4 border border-primary_orange_1 rounded-lg shadow flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
                <div class="min-w-0">
                  <span class="block font-semibold text-gray-800 break-words">{{ q.title }}</span>
                  <span class="block sm:inline text-xs text-gray-500">{{ q.activatedAt | date:'dd-MM-yyyy HH:mm' }}</span>
                </div>

                <div class="flex flex-col sm:flex-row sm:gap-6 gap-1">
                  <span class="text-sm">
                    <strong>{{ 'ACTIVE_LIST.GROUP_STUDENT' | translate }} </strong>
                    <span [ngClass]="{'text-green-600 font-bold': q.studentCompletedAt, 'text-red-600 font-extrabold': !q.studentCompletedAt}">
                      {{ q.student?.fullName }}
                    </span>
                  </span>
                  <span class="text-sm">
                    <strong>{{ 'ACTIVE_LIST.GROUP_TEACHER' | translate }} </strong>
                    <span [ngClass]="{'text-green-600 font-bold': q.teacherCompletedAt, 'text-red-600 font-bold': !q.teacherCompletedAt}">
                      {{ q.teacher?.fullName }}
                    </span>
                  </span>
                </div>

                <div class="flex gap-2 items-center mt-3 sm:mt-0">
                  <button
                    *ngIf="!q.studentCompletedAt"
                    (click)="copyAnswersUrl(q.id)"
                    class="ml-2 cursor-pointer text-sm text-primary_orange_1 font-normal hover:text-primary_orange_light underline underline-offset-2 transition"
                  >
                    {{'TMP_COPY_LINK' | translate}}
                  </button>
                  <button
                    *ngIf="!q.teacherCompletedAt"
                    [routerLink]="['/answer', q.id]"
                    class="px-4 py-2 text-sm bg-primary_orange_1 text-white rounded-md hover:bg-primary_orange_light focus:outline-none"
                  >
                    {{ 'TMP_ANSWER' | translate }}
                  </button>
                  <button
                    *ngIf="q.teacherCompletedAt && q.studentCompletedAt"
                    [routerLink]="['/results', q.id]"
                    class="px-4 py-2 text-sm bg-secondary_blue text-white rounded-md hover:bg-primary_orange focus:outline-none"
                  >
                    {{ 'TMP_VIEW_RESULTS' | translate }}
                  </button>

                  
                </div>
              </li>
            </ul>
          </div>
        </button>
      </div>

      <!-- Fallback when no groups -->
      <div *ngIf="displayedGroups.length === 0" class="text-center p-6 text-gray-600">
        {{ 'TMP_NO_ACTIVE_QUESTIONNAIRES' | translate }}
      </div>
    </div>

    <app-pagination
      *ngIf="!isLoading && !errorMessage"
      [currentPage]="currentPage"
      [totalPages]="totalPages"
      (pageChange)="onPageChange($event)"
      class="mt-8"
    >
    </app-pagination>
  </div>
</div>